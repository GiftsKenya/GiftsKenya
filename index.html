<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gifts Kenya Shop ðŸ‡°ðŸ‡ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js"></script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .hide { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Firebase Config (to be filled by external script) -->
    <script>
        // These will be provided externally
        const __app_id = window.__app_id || 'default-app';
        const __firebase_config = window.__firebase_config || {};
        const __initial_auth_token = window.__initial_auth_token || null;
    </script>

    <!-- Main App Container -->
    <div id="app" class="relative">
        <!-- Header -->
        <header class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl md:text-3xl font-bold">Gifts Kenya Shop ðŸ‡°ðŸ‡ª</h1>
                    <div class="text-sm" id="userInfo">Loading...</div>
                </div>
            </div>
        </header>

        <!-- Cart Floating Button -->
        <button id="cartBtn" class="fixed top-24 right-4 z-40 bg-emerald-500 text-white p-4 rounded-full shadow-2xl hover:bg-emerald-600 transition">
            <div class="relative">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                <span id="cartCount" class="absolute -top-2 -right-2 bg-amber-500 text-xs rounded-full h-6 w-6 flex items-center justify-center">0</span>
            </div>
        </button>

        <!-- Cart Modal -->
        <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hide">
            <div class="absolute right-0 top-0 h-full w-full md:w-96 bg-white shadow-2xl overflow-y-auto fade-in">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Your Cart</h2>
                        <button id="closeCart" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div id="cartItems" class="space-y-4">
                        <!-- Cart items dynamically inserted here -->
                    </div>
                    <div class="mt-8 border-t pt-4">
                        <div class="flex justify-between text-xl font-bold">
                            <span>Total:</span>
                            <span id="cartTotal">KES 0</span>
                        </div>
                        <button id="checkoutBtn" class="w-full mt-6 bg-emerald-500 text-white py-3 rounded-lg font-semibold hover:bg-emerald-600">
                            Proceed to Checkout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PIN Modal -->
        <div id="pinModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hide">
            <div class="flex items-center justify-center min-h-screen">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-96 fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Admin Access</h2>
                    <p class="text-gray-600 mb-6">Enter PIN to enter Studio mode</p>
                    <input type="password" id="pinInput" class="w-full border-2 border-teal-300 rounded-lg px-4 py-3 text-center text-2xl tracking-widest" maxlength="4" placeholder="****">
                    <p id="pinError" class="text-amber-600 text-sm mt-2 hide">Incorrect PIN</p>
                    <div class="flex justify-between mt-6">
                        <button id="cancelPin" class="px-6 py-2 border border-gray-300 rounded-lg">Cancel</button>
                        <button id="submitPin" class="px-6 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600">Submit</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hide">
            <div class="bg-gradient-to-r from-teal-600 to-cyan-600 text-white shadow-lg">
                <div class="container mx-auto px-4 py-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Admin Panel</h2>
                        <button id="logoutBtn" class="bg-white text-teal-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100">
                            Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Product Form -->
            <div class="container mx-auto px-4 py-8">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Product</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="productName" class="w-full border border-gray-300 rounded-lg px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Price (KES)</label>
                            <input type="number" id="productPrice" class="w-full border border-gray-300 rounded-lg px-4 py-3" min="1">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 mb-2">Product Image</label>
                            <input type="file" id="productImage" accept="image/*" class="w-full border border-gray-300 rounded-lg px-4 py-3">
                        </div>
                    </div>
                    <button id="addProductBtn" class="mt-6 bg-teal-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-600">
                        Add Product
                    </button>
                    <div id="uploadStatus" class="mt-4 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2" id="sectionTitle">Featured Products</h2>
            <p class="text-gray-600 mb-8">Authentic Kenyan gifts & crafts</p>
            
            <!-- Products Grid -->
            <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Products dynamically loaded here -->
                <div class="text-center py-12">
                    <div class="animate-pulse">
                        <div class="bg-gray-300 h-64 rounded-xl mb-4"></div>
                        <div class="h-4 bg-gray-300 rounded w-3/4 mx-auto mb-2"></div>
                        <div class="h-4 bg-gray-300 rounded w-1/2 mx-auto"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white mt-12">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-400">Â© 2023 Gifts Kenya Shop. All rights reserved.</p>
                    </div>
                    <button id="studioLink" class="text-gray-400 hover:text-cyan-300 transition">
                        studio
                    </button>
                </div>
            </div>
        </footer>

        <!-- Success Message -->
        <div id="successMsg" class="fixed bottom-4 right-4 bg-emerald-500 text-white px-6 py-3 rounded-lg shadow-xl hide fade-in">
            Order placed successfully! Thank you!
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hide">
            <div class="flex items-center justify-center min-h-screen">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-96 fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Confirm Delete</h2>
                    <p class="text-gray-600 mb-6" id="deleteText">Are you sure you want to delete this product? This action cannot be undone.</p>
                    <div class="flex justify-between">
                        <button id="cancelDelete" class="px-6 py-2 border border-gray-300 rounded-lg">Cancel</button>
                        <button id="confirmDelete" class="px-6 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>    <!-- Firebase and App Logic -->
    <script>
        // Firebase initialization
        let app, auth, db, storage;
        let userId = null;
        let isAdmin = false;
        let cart = JSON.parse(localStorage.getItem('kenya_gifts_cart')) || {};
        let deleteProductId = null;
        let deleteStoragePath = null;

        // Initialize Firebase
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(__firebase_config);
                } else {
                    app = firebase.app();
                }
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                
                // Authenticate user
                authenticateUser();
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }

        // Authenticate user
        async function authenticateUser() {
            try {
                let userCredential;
                if (__initial_auth_token) {
                    userCredential = await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    userCredential = await auth.signInAnonymously();
                }
                userId = userCredential.user.uid;
                document.getElementById('userInfo').textContent = `User: ${userId.substring(0, 8)}...`;
                loadProducts();
                updateCartDisplay();
            } catch (error) {
                console.error('Authentication error:', error);
                document.getElementById('userInfo').textContent = 'Guest User';
                loadProducts();
            }
        }

        // Load products from Firestore
        function loadProducts() {
            const productsRef = db.collection(`artifacts/${__app_id}/public/data/products`);
            
            productsRef.onSnapshot(snapshot => {
                const productsGrid = document.getElementById('productsGrid');
                productsGrid.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const product = { id: doc.id, ...doc.data() };
                    const productCard = createProductCard(product);
                    productsGrid.appendChild(productCard);
                });
                
                if (snapshot.empty) {
                    productsGrid.innerHTML = `
                        <div class="md:col-span-4 text-center py-12">
                            <p class="text-gray-500 text-lg">No products available yet.</p>
                        </div>
                    `;
                }
            }, error => {
                console.error('Error loading products:', error);
                document.getElementById('productsGrid').innerHTML = `
                    <div class="md:col-span-4 text-center py-12">
                        <p class="text-amber-600">Error loading products. Please refresh.</p>
                    </div>
                `;
            });
        }

        // Create product card
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden fade-in';
            card.innerHTML = `
                <div class="relative">
                    <img src="${product.imageUrl || 'https://via.placeholder.com/300x200?text=Product'}" 
                         alt="${product.name}" 
                         class="w-full h-64 object-cover">
                    ${isAdmin ? `
                        <button class="absolute top-2 right-2 bg-amber-500 text-white p-2 rounded-full delete-btn" 
                                data-id="${product.id}" 
                                data-path="${product.storagePath}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    ` : ''}
                </div>
                <div class="p-4">
                    <h3 class="font-bold text-gray-800 text-lg mb-2">${product.name}</h3>
                    <p class="text-emerald-600 font-bold text-xl mb-4">KES ${parseInt(product.price).toLocaleString()}</p>
                    <button class="w-full bg-emerald-50 text-emerald-600 py-2 rounded-lg font-semibold hover:bg-emerald-100 add-to-cart" 
                            data-id="${product.id}" 
                            data-name="${product.name}" 
                            data-price="${product.price}">
                        Add to Cart
                    </button>
                </div>
            `;
            return card;
        }

        // Cart functionality
        function updateCartDisplay() {
            const cartCount = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = cartCount;
            
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cartCount === 0) {
                cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">Your cart is empty</p>';
                cartTotal.textContent = 'KES 0';
                return;
            }
            
            let total = 0;
            cartItems.innerHTML = '';
            
            Object.values(cart).forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'flex items-center justify-between border-b pb-4';
                cartItem.innerHTML = `
                    <div>
                        <h4 class="font-semibold text-gray-800">${item.name}</h4>
                        <p class="text-gray-600 text-sm">KES ${parseInt(item.price).toLocaleString()} Ã— ${item.quantity}</p>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold text-gray-800 mr-4">KES ${itemTotal.toLocaleString()}</span>
                        <button class="text-amber-500 hover:text-amber-700 remove-item" data-id="${item.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                `;
                cartItems.appendChild(cartItem);
            });
            
            cartTotal.textContent = `KES ${total.toLocaleString()}`;
            localStorage.setItem('kenya_gifts_cart', JSON.stringify(cart));
        }

        // Admin functionality
        function toggleAdminMode(enable) {
            isAdmin = enable;
            const adminPanel = document.getElementById('adminPanel');
            const studioLink = document.getElementById('studioLink');
            const sectionTitle = document.getElementById('sectionTitle');
            
            if (enable) {
                adminPanel.classList.remove('hide');
                studioLink.classList.add('text-cyan-300');
                sectionTitle.textContent = 'Admin Product Management';
            } else {
                adminPanel.classList.add('hide');
                studioLink.classList.remove('text-cyan-300');
                sectionTitle.textContent = 'Featured Products';
            }
            loadProducts(); // Refresh to show/hide delete buttons
        }

        // Add product to Firestore
        async function addProduct(name, price, imageFile) {
            try {
                const statusEl = document.getElementById('uploadStatus');
                statusEl.textContent = 'Uploading...';
                statusEl.className = 'mt-4 text-sm text-teal-600';
                
                // Upload image to Storage
                const timestamp = Date.now();
                const fileName = `${timestamp}_${imageFile.name}`;
                const storagePath = `artifacts/${__app_id}/public/images/${fileName}`;
                const storageRef = storage.ref().child(storagePath);
                
                await storageRef.put(imageFile);
                const imageUrl = await storageRef.getDownloadURL();
                
                // Add to Firestore
                await db.collection(`artifacts/${__app_id}/public/data/products`).add({
                    name: name,
                    price: parseFloat(price),
                    imageUrl: imageUrl,
                    storagePath: storagePath,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                statusEl.textContent = 'Product added successfully!';
                statusEl.className = 'mt-4 text-sm text-emerald-600';
                
                // Clear form
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productImage').value = '';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
                
            } catch (error) {
                console.error('Error adding product:', error);
                document.getElementById('uploadStatus').textContent = 'Error adding product';
                document.getElementById('uploadStatus').className = 'mt-4 text-sm text-amber-600';
            }
        }

        // Delete product
        async function deleteProduct(productId, storagePath) {
            try {
                // Delete from Firestore
                await db.collection(`artifacts/${__app_id}/public/data/products`).doc(productId).delete();
                
                // Delete from Storage
                if (storagePath) {
                    const storageRef = storage.ref().child(storagePath);
                    await storageRef.delete();
                }
                
                closeModal('deleteModal');
                
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product');
            }
        }

        // Modal controls
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hide');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hide');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            
            // Cart controls
            document.getElementById('cartBtn').addEventListener('click', () => openModal('cartModal'));
            document.getElementById('closeCart').addEventListener('click', () => closeModal('cartModal'));
            
            // Studio/PIN controls
            document.getElementById('studioLink').addEventListener('click', () => {
                if (isAdmin) {
                    toggleAdminMode(false);
                } else {
                    openModal('pinModal');
                }
            });
            
            document.getElementById('submitPin').addEventListener('click', () => {
                const pin = document.getElementById('pinInput').value;
                const errorEl = document.getElementById('pinError');
                
                if (pin === '7474') {
                    toggleAdminMode(true);
                    closeModal('pinModal');
                    errorEl.classList.add('hide');
                    document.getElementById('pinInput').value = '';
                } else {
                    errorEl.classList.remove('hide');
                }
            });
            
            document.getElementById('cancelPin').addEventListener('click', () => {
                closeModal('pinModal');
                document.getElementById('pinError').classList.add('hide');
                document.getElementById('pinInput').value = '';
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => toggleAdminMode(false));
            
            // Add product
            document.getElementById('addProductBtn').addEventListener('click', async () => {
                const name = document.getElementById('productName').value.trim();
                const price = document.getElementById('productPrice').value;
                const imageFile = document.getElementById('productImage').files[0];
                
                if (!name || !price || !imageFile) {
                    alert('Please fill all fields and select an image');
                    return;
                }
                
                if (parseFloat(price) <= 0) {
                    alert('Price must be positive');
                    return;
                }
                
                await addProduct(name, price, imageFile);
            });
            
            // Checkout
            document.getElementById('checkoutBtn').addEventListener('click', () => {
                cart = {};
                localStorage.removeItem('kenya_gifts_cart');
                updateCartDisplay();
                closeModal('cartModal');
                
                // Show success message
                const successMsg = document.getElementById('successMsg');
                successMsg.classList.remove('hide');
                setTimeout(() => {
                    successMsg.classList.add('hide');
                }, 3000);
            });
            
            // Delete confirmation
            document.getElementById('confirmDelete').addEventListener('click', () => {
                if (deleteProductId) {
                    deleteProduct(deleteProductId, deleteStoragePath);
                }
            });
            
            document.getElementById('cancelDelete').addEventListener('click', () => closeModal('deleteModal'));
            
            // Event delegation for dynamic elements
            document.addEventListener('click', function(e) {
                // Add to cart
                if (e.target.classList.contains('add-to-cart') || e.target.closest('.add-to-cart')) {
                    const btn = e.target.classList.contains('add-to-cart') ? e.target : e.target.closest('.add-to-cart');
                    const id = btn.dataset.id;
                    const name = btn.dataset.name;
                    const price = parseFloat(btn.dataset.price);
                    
                    if (!cart[id]) {
                        cart[id] = { id, name, price, quantity: 0 };
                    }
                    cart[id].quantity++;
                    updateCartDisplay();
                }
                
                // Remove from cart
                if (e.target.classList.contains('remove-item') || e.target.closest('.remove-item')) {
                    const btn = e.target.classList.contains('remove-item') ? e.target : e.target.closest('.remove-item');
                    const id = btn.dataset.id;
                    
                    if (cart[id]) {
                        cart[id].quantity--;
                        if (cart[id].quantity <= 0) {
                            delete cart[id];
                        }
                        updateCartDisplay();
                    }
                }
                
                // Delete product button
                if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
                    const btn = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
                    deleteProductId = btn.dataset.id;
                    deleteStoragePath = btn.dataset.path;
                    
                    document.getElementById('deleteText').textContent = 
                        'Are you sure you want to delete this product? This action cannot be undone.';
                    openModal('deleteModal');
                }
            });
            
            // Close modals on outside click
            document.querySelectorAll('.fixed.bg-black').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.add('hide');
                    }
                });
            });
        });
    </script>
</body>
 </html>
