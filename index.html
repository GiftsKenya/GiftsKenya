<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gifts Kenya Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    .cart-badge {
      animation: pulse 0.3s ease-in-out;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-backdrop {
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="w-full min-h-full bg-gray-50"><!-- Toast Notification Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div><!-- Header -->
  <header class="w-full bg-indigo-600 text-white shadow-lg">
   <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
    <div>
     <h1 id="shop-title" class="text-2xl font-bold">Gifts Kenya Shop ðŸ‡°ðŸ‡ª</h1>
     <p id="user-id-display" class="text-sm text-indigo-100">Loading...</p>
    </div><!-- Cart Button --> <button id="cart-button" class="relative bg-white text-indigo-600 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-50 transition-colors"> <span class="mr-2">ðŸ›’ Cart</span> <span id="cart-badge" class="cart-badge inline-block bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span> </button>
   </div>
  </header><!-- Main Content -->
  <main class="w-full max-w-7xl mx-auto px-4 py-8"><!-- Loading State -->
   <div id="loading-state" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
    <p class="mt-4 text-gray-600">Loading products...</p>
   </div><!-- Products Grid -->
   <div id="products-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div><!-- Empty State -->
   <div id="empty-state" class="hidden text-center py-12">
    <p class="text-xl text-gray-500">No products available</p>
    <p class="text-sm text-gray-400 mt-2">Check back soon!</p>
   </div><!-- Admin Panel -->
   <div id="admin-panel" class="hidden mt-12 bg-red-50 border-2 border-red-200 rounded-lg p-6">
    <div class="flex justify-between items-center mb-6">
     <h2 class="text-2xl font-bold text-red-700">Admin Panel</h2><button id="logout-button" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"> Logout </button>
    </div><!-- Add Product Form -->
    <form id="add-product-form" class="bg-white p-6 rounded-lg shadow">
     <h3 class="text-xl font-semibold text-red-700 mb-4">Add New Product</h3>
     <div class="space-y-4">
      <div><label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label> <input type="text" id="product-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
      </div>
      <div><label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">Price (KES)</label> <input type="number" id="product-price" required min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
      </div>
      <div><label for="product-image" class="block text-sm font-medium text-gray-700 mb-1">Product Image</label> <input type="file" id="product-image" required accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
      </div><button type="submit" id="submit-product-button" class="w-full bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors"> Add Product </button>
     </div>
    </form>
   </div>
  </main><!-- Footer -->
  <footer class="w-full bg-gray-800 text-white py-6 mt-12">
   <div class="max-w-7xl mx-auto px-4 text-center">
    <p class="text-sm text-gray-400">Â© 2024 Gifts Kenya Shop. All rights reserved.</p><button id="studio-link" class="text-xs text-gray-500 hover:text-gray-300 mt-2 transition-colors">studio</button>
   </div>
  </footer><!-- Cart Modal -->
  <div id="cart-modal" class="hidden fixed inset-0 z-50">
   <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-50" id="cart-backdrop"></div>
   <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl">
    <div class="h-full flex flex-col"><!-- Cart Header -->
     <div class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
      <h2 class="text-xl font-bold">Shopping Cart</h2><button id="close-cart" class="text-white hover:text-indigo-200 text-2xl">Ã—</button>
     </div><!-- Cart Items -->
     <div id="cart-items" class="flex-1 overflow-y-auto px-6 py-4">
      <div id="cart-empty" class="text-center py-12 text-gray-500">
       Your cart is empty
      </div>
     </div><!-- Cart Footer -->
     <div class="border-t border-gray-200 px-6 py-4 bg-gray-50">
      <div class="flex justify-between items-center mb-4"><span class="text-lg font-semibold">Total:</span> <span id="cart-total" class="text-2xl font-bold text-indigo-600">KES 0</span>
      </div><button id="checkout-button" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"> Proceed to Checkout </button>
     </div>
    </div>
   </div>
  </div><!-- PIN Modal -->
  <div id="pin-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
   <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-50" id="pin-backdrop"></div>
   <div class="relative bg-white rounded-lg shadow-xl p-8 max-w-sm w-full mx-4">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Access</h2>
    <p class="text-gray-600 mb-4">Enter PIN to access admin panel</p><input type="password" id="pin-input" placeholder="Enter PIN" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent mb-4">
    <div class="flex gap-2"><button id="pin-submit" class="flex-1 bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors"> Login </button> <button id="pin-cancel" class="flex-1 bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400 transition-colors"> Cancel </button>
    </div>
    <p id="pin-error" class="hidden text-red-600 text-sm mt-2">Incorrect PIN</p>
   </div>
  </div><!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
   <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-50" id="delete-backdrop"></div>
   <div class="relative bg-white rounded-lg shadow-xl p-8 max-w-sm w-full mx-4">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Confirm Delete</h2>
    <p class="text-gray-600 mb-6">Are you sure you want to delete this product? This action cannot be undone.</p>
    <div class="flex gap-2"><button id="confirm-delete" class="flex-1 bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors"> Delete </button> <button id="cancel-delete" class="flex-1 bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400 transition-colors"> Cancel </button>
    </div>
   </div>
  </div><!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, signInWithCustomToken, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

    // Default config for SDK
    const defaultConfig = {
      shop_name: "Gifts Kenya Shop ðŸ‡°ðŸ‡ª",
      currency_symbol: "KES",
      checkout_message: "Thank you for your order! Your items will be processed shortly."
    };

    // Initialize config
    let config = { ...defaultConfig };

    // App state
    let cart = [];
    let isAdminMode = false;
    let products = [];
    let unsubscribeProducts = null;
    let productToDelete = null;
    let firebaseInitialized = false;
    let db = null;
    let storage = null;
    let auth = null;
    let userId = null;

    // Initialize Firebase
    async function initializeFirebase() {
      try {
        const app = initializeApp(window.__firebase_config);
        db = getFirestore(app);
        storage = getStorage(app);
        auth = getAuth(app);

        // Authenticate user
        if (window.__initial_auth_token) {
          const userCredential = await signInWithCustomToken(auth, window.__initial_auth_token);
          userId = userCredential.user.uid;
        } else {
          const userCredential = await signInAnonymously(auth);
          userId = userCredential.user.uid;
        }

        document.getElementById('user-id-display').textContent = `User: ${userId}`;
        firebaseInitialized = true;

        // Start listening to products
        startProductsListener();
      } catch (error) {
        console.error('Firebase initialization error:', error);
        showToast('Connection error. Please refresh the page.', 'error');
        document.getElementById('loading-state').innerHTML = '<p class="text-red-600">Failed to connect. Please refresh the page.</p>';
      }
    }

    // Start listening to products collection
    function startProductsListener() {
      const productsPath = `artifacts/${window.__app_id}/public/data/products`;
      const productsRef = collection(db, productsPath);

      unsubscribeProducts = onSnapshot(productsRef, (snapshot) => {
        products = [];
        snapshot.forEach((doc) => {
          products.push({ id: doc.id, ...doc.data() });
        });
        
        renderProducts();
      }, (error) => {
        console.error('Error fetching products:', error);
        showToast('Error loading products', 'error');
      });
    }

    // Render products
    function renderProducts() {
      const grid = document.getElementById('products-grid');
      const loading = document.getElementById('loading-state');
      const empty = document.getElementById('empty-state');

      loading.classList.add('hidden');

      if (products.length === 0) {
        grid.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');
      grid.classList.remove('hidden');
      grid.innerHTML = '';

      products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow';
        
        card.innerHTML = `
          <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
          <div class="p-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">${product.name}</h3>
            <p class="text-2xl font-bold text-indigo-600 mb-4">${config.currency_symbol} ${formatPrice(product.price)}</p>
            <button class="add-to-cart w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors" data-product='${JSON.stringify(product)}'>
              Add to Cart
            </button>
            ${isAdminMode ? `<button class="delete-product w-full bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors mt-2" data-product='${JSON.stringify(product)}'>Delete</button>` : ''}
          </div>
        `;

        grid.appendChild(card);
      });

      // Add event listeners
      document.querySelectorAll('.add-to-cart').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const product = JSON.parse(e.target.getAttribute('data-product'));
          addToCart(product);
        });
      });

      if (isAdminMode) {
        document.querySelectorAll('.delete-product').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const product = JSON.parse(e.target.getAttribute('data-product'));
            showDeleteConfirmation(product);
          });
        });
      }
    }

    // Format price
    function formatPrice(price) {
      return new Intl.NumberFormat('en-KE').format(price);
    }

    // Add to cart
    function addToCart(product) {
      const existingItem = cart.find(item => item.id === product.id);
      
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({ ...product, quantity: 1 });
      }

      updateCartBadge();
      showToast(`${product.name} added to cart`, 'success');
    }

    // Update cart badge
    function updateCartBadge() {
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById('cart-badge').textContent = totalItems;
    }

    // Show cart modal
    function showCart() {
      const modal = document.getElementById('cart-modal');
      modal.classList.remove('hidden');
      renderCart();
    }

    // Hide cart modal
    function hideCart() {
      document.getElementById('cart-modal').classList.add('hidden');
    }

    // Render cart
    function renderCart() {
      const container = document.getElementById('cart-items');
      const emptyState = document.getElementById('cart-empty');
      const checkoutButton = document.getElementById('checkout-button');

      if (cart.length === 0) {
        emptyState.classList.remove('hidden');
        checkoutButton.disabled = true;
        document.getElementById('cart-total').textContent = `${config.currency_symbol} 0`;
        return;
      }

      emptyState.classList.add('hidden');
      checkoutButton.disabled = false;

      let html = '';
      let total = 0;

      cart.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;

        html += `
          <div class="flex items-center gap-4 py-4 border-b border-gray-200">
            <img src="${item.imageUrl}" alt="${item.name}" class="w-20 h-20 object-cover rounded">
            <div class="flex-1">
              <h3 class="font-semibold text-gray-800">${item.name}</h3>
              <p class="text-sm text-gray-600">${config.currency_symbol} ${formatPrice(item.price)} Ã— ${item.quantity}</p>
              <p class="text-lg font-bold text-indigo-600">${config.currency_symbol} ${formatPrice(itemTotal)}</p>
            </div>
            <button class="remove-item bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors" data-index="${index}">Remove</button>
          </div>
        `;
      });

      container.innerHTML = html;
      document.getElementById('cart-total').textContent = `${config.currency_symbol} ${formatPrice(total)}`;

      // Add remove listeners
      document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.getAttribute('data-index'));
          removeFromCart(index);
        });
      });
    }

    // Remove from cart
    function removeFromCart(index) {
      const item = cart[index];
      
      if (item.quantity > 1) {
        item.quantity -= 1;
      } else {
        cart.splice(index, 1);
      }

      updateCartBadge();
      renderCart();
    }

    // Checkout
    function checkout() {
      if (cart.length === 0) return;

      cart = [];
      updateCartBadge();
      hideCart();
      showToast(config.checkout_message, 'success');
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg max-w-sm`;
      toast.textContent = message;
      
      container.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Show PIN modal
    function showPinModal() {
      if (isAdminMode) {
        toggleAdminMode();
        return;
      }

      document.getElementById('pin-modal').classList.remove('hidden');
      document.getElementById('pin-input').value = '';
      document.getElementById('pin-error').classList.add('hidden');
      document.getElementById('pin-input').focus();
    }

    // Hide PIN modal
    function hidePinModal() {
      document.getElementById('pin-modal').classList.add('hidden');
    }

    // Check PIN
    function checkPin() {
      const pin = document.getElementById('pin-input').value;
      
      if (pin === '7474') {
        hidePinModal();
        activateAdminMode();
      } else {
        document.getElementById('pin-error').classList.remove('hidden');
      }
    }

    // Activate admin mode
    function activateAdminMode() {
      isAdminMode = true;
      document.getElementById('admin-panel').classList.remove('hidden');
      document.getElementById('studio-link').classList.add('text-red-500');
      renderProducts();
      showToast('Admin mode activated', 'success');
    }

    // Toggle admin mode
    function toggleAdminMode() {
      isAdminMode = false;
      document.getElementById('admin-panel').classList.add('hidden');
      document.getElementById('studio-link').classList.remove('text-red-500');
      renderProducts();
      showToast('Admin mode deactivated', 'info');
    }

    // Add product
    async function addProduct(e) {
      e.preventDefault();

      if (!firebaseInitialized) {
        showToast('Firebase not initialized', 'error');
        return;
      }

      const submitButton = document.getElementById('submit-product-button');
      submitButton.disabled = true;
      submitButton.textContent = 'Uploading...';

      try {
        const name = document.getElementById('product-name').value;
        const price = parseFloat(document.getElementById('product-price').value);
        const imageFile = document.getElementById('product-image').files[0];

        if (!imageFile) {
          throw new Error('Please select an image');
        }

        // Upload image
        const timestamp = Date.now();
        const fileName = `${timestamp}_${imageFile.name}`;
        const storagePath = `artifacts/${window.__app_id}/public/images/${fileName}`;
        const storageRef = ref(storage, storagePath);
        
        await uploadBytes(storageRef, imageFile);
        const imageUrl = await getDownloadURL(storageRef);

        // Add product to Firestore
        const productsPath = `artifacts/${window.__app_id}/public/data/products`;
        await addDoc(collection(db, productsPath), {
          name,
          price,
          imageUrl,
          storagePath,
          createdAt: Date.now()
        });

        // Reset form
        document.getElementById('add-product-form').reset();
        showToast('Product added successfully!', 'success');
      } catch (error) {
        console.error('Error adding product:', error);
        showToast('Failed to add product', 'error');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Add Product';
      }
    }

    // Show delete confirmation
    function showDeleteConfirmation(product) {
      productToDelete = product;
      document.getElementById('delete-modal').classList.remove('hidden');
    }

    // Hide delete confirmation
    function hideDeleteConfirmation() {
      productToDelete = null;
      document.getElementById('delete-modal').classList.add('hidden');
    }

    // Confirm delete
    async function confirmDelete() {
      if (!productToDelete || !firebaseInitialized) return;

      const confirmButton = document.getElementById('confirm-delete');
      confirmButton.disabled = true;
      confirmButton.textContent = 'Deleting...';

      try {
        // Delete from Storage
        if (productToDelete.storagePath) {
          const storageRef = ref(storage, productToDelete.storagePath);
          await deleteObject(storageRef);
        }

        // Delete from Firestore
        const productsPath = `artifacts/${window.__app_id}/public/data/products`;
        await deleteDoc(doc(db, productsPath, productToDelete.id));

        showToast('Product deleted successfully', 'success');
        hideDeleteConfirmation();
      } catch (error) {
        console.error('Error deleting product:', error);
        showToast('Failed to delete product', 'error');
      } finally {
        confirmButton.disabled = false;
        confirmButton.textContent = 'Delete';
      }
    }

    // Event listeners
    document.getElementById('cart-button').addEventListener('click', showCart);
    document.getElementById('close-cart').addEventListener('click', hideCart);
    document.getElementById('cart-backdrop').addEventListener('click', hideCart);
    document.getElementById('checkout-button').addEventListener('click', checkout);
    
    document.getElementById('studio-link').addEventListener('click', showPinModal);
    document.getElementById('pin-submit').addEventListener('click', checkPin);
    document.getElementById('pin-cancel').addEventListener('click', hidePinModal);
    document.getElementById('pin-backdrop').addEventListener('click', hidePinModal);
    document.getElementById('pin-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') checkPin();
    });
    
    document.getElementById('logout-button').addEventListener('click', toggleAdminMode);
    document.getElementById('add-product-form').addEventListener('submit', addProduct);
    
    document.getElementById('confirm-delete').addEventListener('click', confirmDelete);
    document.getElementById('cancel-delete').addEventListener('click', hideDeleteConfirmation);
    document.getElementById('delete-backdrop').addEventListener('click', hideDeleteConfirmation);

    // onConfigChange function for SDK
    async function onConfigChange(newConfig) {
      Object.assign(config, newConfig);
      
      // Update shop title
      const shopTitle = document.getElementById('shop-title');
      if (shopTitle) {
        shopTitle.textContent = config.shop_name || defaultConfig.shop_name;
      }
      
      // Re-render products and cart to update currency
      renderProducts();
      if (!document.getElementById('cart-modal').classList.contains('hidden')) {
        renderCart();
      }
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["shop_name", config.shop_name || defaultConfig.shop_name],
          ["currency_symbol", config.currency_symbol || defaultConfig.currency_symbol],
          ["checkout_message", config.checkout_message || defaultConfig.checkout_message]
        ])
      });
    }

    // Initialize Firebase on page load
    initializeFirebase();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a5ce7246174acb3',t:'MTc2NDM2NDc2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
